steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-f',
        'Dockerfile.cloudrun',
        '-t',
        'gcr.io/$PROJECT_ID/teamcruz-backend:latest',
        '.',
      ]

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/teamcruz-backend:latest']

  # Deploy container image to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'teamcruz-backend'
      - '--image'
      - 'gcr.io/$PROJECT_ID/teamcruz-backend:latest'
      - '--region'
      - 'southamerica-east1'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--port'
      - '8080'
      - '--memory'
      - '1Gi'
      - '--cpu'
      - '1'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--set-env-vars'
      - 'NODE_ENV=production,DB_HOST=/cloudsql/teamcruz-controle-alunos:southamerica-east1:teamcruz-db,DB_USER=teamcruz_app,DB_PASS=TeamCruz2024@,DB_NAME=teamcruz_db,JWT_SECRET=jwt_secret_muito_forte_para_producao_123456789,CORS_ORIGIN=https://teamcruz-frontend-943403834207.southamerica-east1.run.app'
      - '--timeout'
      - '300'

images:
  - gcr.io/$PROJECT_ID/teamcruz-backend:latest
