# üìö Guia de Autentica√ß√£o e Controle de Acesso - TeamCruz

## üéØ Vis√£o Geral

Este documento descreve a estrutura completa de autentica√ß√£o, perfis de acesso e permiss√µes do sistema TeamCruz Jiu-Jitsu.

## üîê Arquitetura de Autentica√ß√£o

### Backend (NestJS)

#### Guards
- **JwtAuthGuard**: Valida tokens JWT nas rotas protegidas
- **LocalAuthGuard**: Valida credenciais no login (username/email + senha)

#### Estrat√©gia JWT
- Localiza√ß√£o: `backend/src/auth/strategies/jwt.strategy.ts`
- Extrai token do header `Authorization: Bearer <token>`
- Valida token e popula dados do usu√°rio no request

#### Servi√ßos Principais
- **AuthService** (`backend/src/auth/auth.service.ts`)
  - `login()`: Autentica√ß√£o e gera√ß√£o de token
  - `validateToken()`: Valida√ß√£o de token JWT
  - `getUserProfile()`: Retorna perfil completo do usu√°rio
  - `registerAluno()`: Auto-cadastro de alunos
  - `completeProfile()`: Completar dados ap√≥s primeiro login

- **UsuariosService** (`backend/src/usuarios/services/usuarios.service.ts`)
  - `create()`: Cria√ß√£o de novos usu√°rios
  - `findAll()`: Listar todos os usu√°rios
  - `findPendingApproval()`: Usu√°rios aguardando aprova√ß√£o
  - `approveUser()`: Aprovar usu√°rio
  - `rejectUser()`: Rejeitar e remover usu√°rio
  - `getUserPermissions()`: Retornar c√≥digos de permiss√µes
  - `getUserPerfis()`: Retornar nomes dos perfis

### Frontend (Next.js)

#### Contexto de Autentica√ß√£o
- **AuthContext** (`frontend/app/auth/AuthContext.tsx`)
  - Gerencia estado global de autentica√ß√£o
  - Fun√ß√µes: `login()`, `logout()`, `checkAuthStatus()`
  - Prov√™: `user`, `loading`, `isAuthenticated`

#### Servi√ßo de Autentica√ß√£o
- **authService** (`frontend/lib/services/authService.ts`)
  - `login()`: Chamada ao endpoint de login
  - `validateToken()`: Valida√ß√£o via `/auth/profile`
  - `register()`: Auto-cadastro
  - `completeProfile()`: Completar perfil

#### Componentes de Prote√ß√£o
- **ProtectedRoute** (`frontend/components/auth/ProtectedRoute.tsx`)
  - Componente wrapper para proteger rotas
  - Suporta verifica√ß√£o de perfis e permiss√µes
  - Exibe mensagem de acesso negado quando necess√°rio

#### Hook de Permiss√µes
- **usePermissions** (`frontend/hooks/usePermissions.ts`)
  - Fun√ß√µes utilit√°rias para verifica√ß√£o de acesso
  - M√©todos dispon√≠veis:
    - `hasPerfil(perfil: string)`: Verifica perfil espec√≠fico
    - `hasAnyPerfil(perfis: string[])`: Verifica qualquer perfil da lista
    - `hasAllPerfis(perfis: string[])`: Verifica todos os perfis
    - `hasPermission(permission: string)`: Verifica permiss√£o espec√≠fica
    - `isMaster()`, `isFranqueado()`, `isInstrutor()`, `isAluno()`
    - `getUserPerfis()`, `getUserPermissions()`

---

## üë• Perfis de Acesso

### 1. Master (Administrador do Sistema)
**Descri√ß√£o**: Controle total do sistema

**Permiss√µes**:
- ‚úÖ Gerenciar todos os usu√°rios
- ‚úÖ Aprovar/rejeitar cadastros
- ‚úÖ Gerenciar franqueados e unidades
- ‚úÖ Configurar sistema de gradua√ß√£o
- ‚úÖ Configurar sistema de presen√ßa
- ‚úÖ Associar professores a unidades
- ‚úÖ Visualizar relat√≥rios completos
- ‚úÖ Gerenciar perfis e permiss√µes

**Rotas Acess√≠veis**:
- `/dashboard` - Dashboard Master
- `/usuarios` - Gest√£o de usu√°rios
- `/admin/usuarios-pendentes` - Aprova√ß√£o de cadastros
- `/admin/gestao-franqueados` - Gest√£o de franqueados
- `/admin/gestao-unidades` - Gest√£o de unidades
- `/admin/sistema-graduacao` - Sistema de gradua√ß√£o
- `/admin/sistema-presenca` - Sistema de presen√ßa
- `/alunos` - Gest√£o de alunos
- `/professores` - Gest√£o de professores
- `/franqueados` - Visualizar franqueados
- `/unidades` - Visualizar unidades

### 2. Franqueado
**Descri√ß√£o**: Dono de unidade(s)

**Permiss√µes**:
- ‚úÖ Visualizar dados das suas unidades
- ‚úÖ Gerenciar alunos das suas unidades
- ‚úÖ Visualizar professores das suas unidades
- ‚úÖ Relat√≥rios de presen√ßa das suas unidades
- ‚úÖ Relat√≥rios de gradua√ß√£o das suas unidades

**Rotas Acess√≠veis**:
- `/dashboard` - Dashboard Franqueado
- `/alunos` - Alunos das suas unidades (filtrado)
- `/presenca` - Presen√ßa das suas unidades
- `/graduacao` - Gradua√ß√£o das suas unidades

### 3. Instrutor/Professor
**Descri√ß√£o**: Professor de uma ou mais unidades

**Permiss√µes**:
- ‚úÖ Registrar presen√ßa dos alunos
- ‚úÖ Visualizar seus alunos
- ‚úÖ Registrar evolu√ß√£o de gradua√ß√£o
- ‚úÖ Visualizar hor√°rios de aula

**Rotas Acess√≠veis**:
- `/dashboard` - Dashboard Instrutor
- `/meus-alunos` - Lista de alunos do professor
- `/presenca` - Registrar presen√ßa
- `/graduacao` - Registrar evolu√ß√£o
- `/horarios` - Hor√°rios de aula

### 4. Aluno
**Descri√ß√£o**: Aluno matriculado

**Permiss√µes**:
- ‚úÖ Visualizar pr√≥prio progresso
- ‚úÖ Visualizar pr√≥pria frequ√™ncia
- ‚úÖ Visualizar hor√°rios de aula

**Rotas Acess√≠veis**:
- `/dashboard` - Dashboard Aluno
- `/meu-progresso` - Progresso e gradua√ß√£o
- `/horarios` - Hor√°rios de aula

---

## üîí Endpoints Protegidos

### Backend

#### Endpoints P√∫blicos (sem autentica√ß√£o)
```
POST /auth/login
POST /auth/register
POST /auth/forgot-password
POST /auth/reset-password
GET  /auth/health
```

#### Endpoints Protegidos (requerem JWT)
```
GET  /auth/profile          - @UseGuards(JwtAuthGuard)
GET  /auth/me               - @UseGuards(JwtAuthGuard)
POST /auth/complete-profile - @UseGuards(JwtAuthGuard)
POST /auth/refresh          - @UseGuards(JwtAuthGuard)
POST /auth/change-password  - @UseGuards(JwtAuthGuard)

GET    /usuarios/pendentes/list - @UseGuards(JwtAuthGuard)
PATCH  /usuarios/:id/aprovar    - @UseGuards(JwtAuthGuard)
PATCH  /usuarios/:id/rejeitar   - @UseGuards(JwtAuthGuard)
```

### Frontend

#### Rotas P√∫blicas
```
/login
/register
/auth/callback
```

#### Rotas Protegidas (requerem autentica√ß√£o)
```
/dashboard
/complete-profile
/usuarios
/alunos
/professores
/franqueados
/unidades
/presenca
/graduacao
/horarios
/meu-progresso
/meus-alunos
```

#### Rotas Admin (requerem perfil Master)
```
/admin/usuarios-pendentes
/admin/gestao-franqueados
/admin/gestao-unidades
/admin/sistema-graduacao
/admin/sistema-presenca
```

---

## üõ†Ô∏è Como Usar

### Proteger uma Rota no Frontend

```tsx
import ProtectedRoute from "@/components/auth/ProtectedRoute";

export default function MyProtectedPage() {
  return (
    <ProtectedRoute requiredPerfis={["master", "franqueado"]}>
      <div>Conte√∫do protegido</div>
    </ProtectedRoute>
  );
}
```

### Usar Hook de Permiss√µes

```tsx
import { usePermissions } from "@/hooks/usePermissions";

function MyComponent() {
  const { isMaster, hasPerfil, hasPermission } = usePermissions();

  if (isMaster()) {
    return <AdminPanel />;
  }

  if (hasPerfil("instrutor")) {
    return <InstructorPanel />;
  }

  return <DefaultView />;
}
```

### Proteger Endpoint no Backend

```typescript
@UseGuards(JwtAuthGuard)
@Get('my-protected-route')
async myProtectedRoute(@Request() req) {
  // req.user cont√©m os dados do usu√°rio autenticado
  return this.myService.getData(req.user.id);
}
```

---

## üîÑ Fluxo de Autentica√ß√£o

### 1. Login
```
1. Usu√°rio envia email/username e senha para POST /auth/login
2. Backend valida credenciais via LocalAuthGuard
3. Backend gera token JWT com payload:
   - sub: userId
   - username
   - email
   - permissions: array de c√≥digos de permiss√µes
4. Backend retorna:
   - access_token
   - user: { id, username, email, nome, cadastro_completo, permissions, permissionsDetail, perfis }
5. Frontend armazena token no localStorage
6. Frontend atualiza AuthContext com dados do usu√°rio
7. Redirecionamento autom√°tico para /dashboard ou /complete-profile
```

### 2. Valida√ß√£o Autom√°tica
```
1. App carrega, AuthContext executa checkAuthStatus()
2. Busca token do localStorage
3. Chama GET /auth/profile com token
4. Backend valida token via JwtAuthGuard
5. Backend retorna dados completos do usu√°rio
6. Frontend atualiza estado de autentica√ß√£o
```

### 3. Acesso a Rota Protegida
```
1. Usu√°rio navega para rota protegida
2. ProtectedRoute verifica se est√° autenticado
3. Se n√£o autenticado, redireciona para /login
4. Se autenticado, verifica perfis/permiss√µes necess√°rias
5. Se tem acesso, renderiza conte√∫do
6. Se n√£o tem acesso, exibe mensagem de acesso negado
```

---

## üìä Estrutura de Dados

### Usu√°rio (Backend)
```typescript
{
  id: string (UUID),
  username: string,
  email: string,
  password: string (hash bcrypt),
  nome: string,
  cpf?: string,
  telefone?: string,
  ativo: boolean,
  cadastro_completo: boolean,
  ultimo_login?: Date,
  created_at: Date,
  updated_at: Date,
  perfis: Perfil[]
}
```

### Perfil
```typescript
{
  id: string (UUID),
  nome: string,  // "Master", "Franqueado", "Instrutor", "Aluno"
  descricao: string,
  ativo: boolean,
  permissoes: Permissao[]
}
```

### Permiss√£o
```typescript
{
  id: string (UUID),
  codigo: string,  // Identificador √∫nico (ex: "usuarios:criar")
  nome: string,
  descricao: string,
  modulo: string,  // M√≥dulo do sistema
  nivel: PermissaoNivel,
  tipo: PermissaoTipo
}
```

### Payload JWT
```typescript
{
  sub: string,        // userId
  username: string,
  email: string,
  permissions: string[],  // Array de c√≥digos de permiss√£o
  iat: number,
  exp: number
}
```

### Dados do Usu√°rio Retornados
```typescript
{
  id: string,
  username: string,
  email: string,
  nome: string,
  cpf?: string,
  telefone?: string,
  ativo: boolean,
  cadastro_completo: boolean,
  ultimo_login?: Date,
  perfis: string[],  // Array de nomes de perfis
  permissions: string[],  // Array de c√≥digos de permiss√µes
  permissionsDetail: PermissionDetail[]  // Array com detalhes completos
}
```

---

## üß™ Testando Autentica√ß√£o

### Criar Usu√°rio Master Manualmente (via SQL)
```sql
-- 1. Buscar ID do perfil Master
SELECT id FROM perfis WHERE nome = 'Master';

-- 2. Criar usu√°rio (senha: "admin123")
INSERT INTO usuarios (id, username, email, password, nome, ativo, cadastro_completo)
VALUES (
  uuid_generate_v4(),
  'admin',
  'admin@teamcruz.com',
  '$2b$10$YourHashedPasswordHere',
  'Administrador',
  true,
  true
);

-- 3. Associar perfil Master
INSERT INTO usuario_perfis (usuario_id, perfil_id)
VALUES (
  (SELECT id FROM usuarios WHERE username = 'admin'),
  (SELECT id FROM perfis WHERE nome = 'Master')
);
```

### Testar Login via API
```bash
curl -X POST http://localhost:4000/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@teamcruz.com",
    "password": "admin123"
  }'
```

### Testar Rota Protegida
```bash
curl -X GET http://localhost:4000/auth/profile \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

---

## üêõ Troubleshooting

### Problema: "Access Denied" mesmo logado como Master
**Solu√ß√£o**: 
1. Verificar se perfis est√£o sendo retornados no `/auth/profile`
2. Abrir console e verificar `userData.perfis`
3. Confirmar que backend est√° populando `usuario.perfis` com relations

### Problema: Token expirado
**Solu√ß√£o**: 
- Tokens JWT expiram em 30 minutos
- Implementar refresh token ou fazer novo login

### Problema: Perfis n√£o sendo reconhecidos
**Solu√ß√£o**:
- Verificar se `getUserPerfis()` retorna array de strings (nomes dos perfis)
- Confirmar que frontend est√° normalizando perfis (case-insensitive)
- Usar hook `usePermissions` para verifica√ß√µes

---

## üìù Arquivos Importantes

### Backend
```
src/auth/
‚îú‚îÄ‚îÄ auth.controller.ts       - Endpoints de autentica√ß√£o
‚îú‚îÄ‚îÄ auth.service.ts          - L√≥gica de autentica√ß√£o
‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts    - Guard JWT
‚îÇ   ‚îî‚îÄ‚îÄ local-auth.guard.ts  - Guard de login
‚îî‚îÄ‚îÄ strategies/
    ‚îî‚îÄ‚îÄ jwt.strategy.ts      - Estrat√©gia JWT

src/usuarios/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ usuarios.controller.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ usuarios.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ perfis.service.ts
‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îú‚îÄ‚îÄ usuario.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ perfil.entity.ts
‚îÇ   ‚îî‚îÄ‚îÄ permissao.entity.ts
‚îî‚îÄ‚îÄ dto/
    ‚îî‚îÄ‚îÄ create-usuario.dto.ts
```

### Frontend
```
app/auth/
‚îî‚îÄ‚îÄ AuthContext.tsx          - Contexto de autentica√ß√£o

components/auth/
‚îî‚îÄ‚îÄ ProtectedRoute.tsx       - Componente de prote√ß√£o

hooks/
‚îî‚îÄ‚îÄ usePermissions.ts        - Hook de permiss√µes

lib/services/
‚îî‚îÄ‚îÄ authService.ts           - Servi√ßo de autentica√ß√£o

components/dashboard/
‚îú‚îÄ‚îÄ MasterDashboard.tsx
‚îú‚îÄ‚îÄ FranqueadoDashboard.tsx
‚îú‚îÄ‚îÄ InstrutorDashboard.tsx
‚îî‚îÄ‚îÄ AlunoDashboard.tsx
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [x] JwtAuthGuard implementado
- [x] LocalAuthGuard implementado  
- [x] JWT Strategy configurada
- [x] AuthContext criado
- [x] authService implementado
- [x] ProtectedRoute component criado
- [x] usePermissions hook criado
- [x] Dashboards espec√≠ficos por perfil
- [x] Rota de aprova√ß√£o de usu√°rios (Master only)
- [x] Sistema de perfis e permiss√µes
- [x] Documenta√ß√£o completa
- [x] Arquivos de teste/debug removidos

---

## üöÄ Pr√≥ximos Passos Sugeridos

1. **Implementar Refresh Token**
   - Adicionar endpoint de refresh
   - Armazenar refresh token em httpOnly cookie
   - Auto-renova√ß√£o de tokens

2. **Adicionar Rate Limiting**
   - Proteger endpoints de login
   - Prevenir brute force

3. **Implementar 2FA (Autentica√ß√£o de Dois Fatores)**
   - TOTP via Google Authenticator
   - SMS/Email de verifica√ß√£o

4. **Auditoria de Acesso**
   - Log de todas as a√ß√µes
   - Hist√≥rico de logins
   - Rastreamento de mudan√ßas

5. **Pol√≠tica de Senhas**
   - Complexidade m√≠nima
   - Expira√ß√£o peri√≥dica
   - Hist√≥rico de senhas

---

**√öltima atualiza√ß√£o**: 2025-10-05
**Vers√£o**: 1.0.0
